<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>节日·节气倒计时（修复版）</title>
<style>
html,body{margin:0;height:100%}body{background:url("https://bing.img.run/1920x1080.php") center/cover fixed;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;color:#fff;overflow-x:hidden}body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:-1}.container{max-width:100%;margin:0 auto;padding:0 15px}.header{text-align:center;padding:20px 10px 30px}.header h1{font-size:28px;font-weight:700;margin-bottom:10px;text-shadow:0 2px 10px rgba(0,0,0,.4)}.beijing-time{font-size:18px;margin-bottom:5px;text-shadow:0 1px 3px rgba(0,0,0,.5)}.header p{font-size:14px;opacity:.8}.countdown-list{margin-bottom:30px}.countdown-item{background:rgba(255,255,255,.12);backdrop-filter:blur(10px);border-radius:16px;padding:20px;margin-bottom:15px;border:1px solid rgba(255,255,255,.15);transition:all .3s ease}.countdown-item:hover{transform:translateY(-3px);background:rgba(255,255,255,.18)}.countdown-item.holiday{border-left:4px solid #ffd93d}.countdown-item.solar-term{border-left:4px solid #6bcf7f}.event-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.event-name{font-size:18px;font-weight:600}.event-date{font-size:14px;opacity:.8}.countdown-display{display:flex;justify-content:space-around;text-align:center}.countdown-unit{flex:1;position:relative}.countdown-unit:not(:last-child)::after{content:":";position:absolute;right:-5px;top:50%;transform:translateY(-55%);font-size:24px;font-weight:700;opacity:.4}.countdown-number{font-size:28px;font-weight:700;line-height:1}.countdown-label{font-size:12px;opacity:.7;margin-top:8px;letter-spacing:.5px}.days .countdown-number{color:#ffd93d;text-shadow:0 0 10px rgba(255,217,61,.3)}.hours .countdown-number{color:#6bcf7f;text-shadow:0 0 10px rgba(107,207,127,.3)}.minutes .countdown-number{color:#4cc9f0;text-shadow:0 0 10px rgba(76,201,240,.3)}.seconds .countdown-number{color:#f72585;text-shadow:0 0 10px rgba(247,37,133,.3)}.section-title{font-size:20px;margin:25px 0 15px;padding-left:10px;position:relative;font-weight:600}.section-title::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:20px;border-radius:2px}.section-title.holiday::before{background:#ffd93d}.section-title.solar-term::before{background:#6bcf7f}.loading{text-align:center;padding:50px;font-size:16px}@media(max-width:480px){.header h1{font-size:24px}.beijing-time{font-size:16px}.event-name{font-size:16px}.countdown-number{font-size:24px}.countdown-unit:not(:last-child)::after{font-size:20px}}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>节日·节气倒计时</h1>
        <div class="beijing-time" id="beijing-time">北京时间：加载中…</div>
        <p>记录美好时光，期待每一个重要时刻</p>
    </div>

    <div id="loading" class="loading">正在加载数据…</div>

    <div id="content" style="display:none">
        <h2 class="section-title holiday">传统节日</h2>
        <div id="holidays" class="countdown-list"></div>

        <h2 class="section-title solar-term">24 节气</h2>
        <div id="solar-terms" class="countdown-list"></div>
    </div>
</div>

<!-- ========== 1. 引入稳定开源库：lunar-javascript ========== -->
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
<script>
/* ---------- 2. 生成“下一个”节日/节气列表 ---------- */
function getNextFestivals() {
    const now = new Date();
    const y = now.getFullYear();
    /* 法定公历节日（固定日期） */
    const fixed = [
        { name: '元旦', month: 1, day: 1 },
        { name: '劳动节', month: 5, day: 1 },
        { name: '国庆节', month: 10, day: 1 }
    ].map(f => {
        let d = new Date(y, f.month - 1, f.day);
        if (d < now) d = new Date(y + 1, f.month - 1, f.day);
        return { name: f.name, date: d };
    });
    /* 农历节日（春节、元宵、端午、中秋、重阳） */
    const lunarFest = [
        { name: '春节', m: 1, d: 1 },
        { name: '元宵节', m: 1, d: 15 },
        { name: '端午节', m: 5, d: 5 },
        { name: '中秋节', m: 8, d: 15 },
        { name: '重阳节', m: 9, d: 9 }
    ].map(f => {
        let l = Lunar.fromYmd(y, f.m, f.d);
        let d = l.getSolar().toDate();
        if (d < now) l = Lunar.fromYmd(y + 1, f.m, f.d), d = l.getSolar().toDate();
        return { name: f.name, date: d };
    });
    /* 清明节 = 春分后第15天（天文算法） */
    const qingming = (() => {
        const春分 = SolarTerm.fromIndex(y, 3); /* 3=春分 */
        let d = new Date(春分.getJulianDay().getMilliseconds() + 15 * 86400000);
        if (d < now) { const c2 = SolarTerm.fromIndex(y + 1, 3); d = new Date(c2.getJulianDay().getMilliseconds() + 15 * 86400000); }
        return { name: '清明节', date: d };
    })();
    return [...fixed, ...lunarFest, qingming].sort((a, b) => a.date - b.date);
}

function getNextSolarTerms() {
    const list = [];
    let y = new Date().getFullYear();
    for (let i = 0; i < 25; i++) { /* 取未来 25 个节气足够显示 */
        for (let j = 0; j < 24; j++) {
            const t = SolarTerm.fromIndex(y, j);
            const bj = new Date(t.getJulianDay().getMilliseconds() + 8 * 3600000); /* UTC→北京 */
            if (bj > new Date()) list.push({ name: t.getName(), date: bj });
            if (list.length >= 24) break;
        }
        if (list.length >= 24) break;
        y++;
    }
    return list;
}

/* ---------- 3. 渲染 + 倒计时 ---------- */
class FestivalCountdown {
    constructor() { this.init(); }
    init() {
        this.loadData();
        this.startCountdown();
        this.updateBeijingTime();
        setInterval(() => this.updateBeijingTime(), 1000);
    }
    loadData() {
        const holidays = getNextFestivals();
        const solarTerms = getNextSolarTerms();
        this.renderEvents('holidays', holidays, 'holiday');
        this.renderEvents('solar-terms', solarTerms.slice(0, 12), 'solar-term');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
    }
    renderEvents(containerId, events, type) {
        const container = document.getElementById(containerId);
        container.innerHTML = events.map(e => `
            <div class="countdown-item ${type}" data-date="${e.date.getTime()}">
                <div class="event-header">
                    <div class="event-name">${e.name}</div>
                    <div class="event-date">${e.date.getFullYear()}年${String(e.date.getMonth()+1).padStart(2,'0')}月${String(e.date.getDate()).padStart(2,'0')}日</div>
                </div>
                <div class="countdown-display">
                    <div class="countdown-unit days"><span class="countdown-number">0</span><div class="countdown-label">天</div></div>
                    <div class="countdown-unit hours"><span class="countdown-number">0</span><div class="countdown-label">时</div></div>
                    <div class="countdown-unit minutes"><span class="countdown-number">0</span><div class="countdown-label">分</div></div>
                    <div class="countdown-unit seconds"><span class="countdown-number">0</span><div class="countdown-label">秒</div></div>
                </div>
            </div>
        `).join('');
    }
    startCountdown() {
        setInterval(() => {
            document.querySelectorAll('.countdown-item').forEach(item => {
                const diff = Number(item.dataset.date) - Date.now();
                const d = Math.floor(diff / 86400000);
                const h = Math.floor((diff % 86400000) / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                item.querySelector('.days   .countdown-number').textContent = Math.max(0, d);
                item.querySelector('.hours  .countdown-number').textContent = Math.max(0, h);
                item.querySelector('.minutes .countdown-number').textContent = Math.max(0, m);
                item.querySelector('.seconds .countdown-number').textContent = Math.max(0, s);
            });
        }, 1000);
    }
    updateBeijingTime() {
        const beijing = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
        document.getElementById('beijing-time').textContent = `北京时间：${beijing}`;
    }
}
new FestivalCountdown();
</script>
</body>
</html>
